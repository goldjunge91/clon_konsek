- name: Verify secrets & Create env file
  run: |
    cd $GITHUB_WORKSPACE
    cat << EOF > .env
    ENABLE_GOOGLE_AUTH=${{ secrets.ENABLE_GOOGLE_AUTH }}
    GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
    GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}

    ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
    ENCRYPTION_IV=${{ secrets.ENCRYPTION_IV }}

    NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
    NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
    NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"

    DB_HOST=${{ secrets.DB_HOST }}
    DB_NAME=${{ secrets.DB_NAME }}
    DB_USER=${{ secrets.DB_USER }}
    DB_PASSWORD=${{ secrets.DB_PASSWORD }}
    DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5432/${{ secrets.DB_NAME }}
    EOF

    # Verify that the .env file was created successfully
    if [ -s ".env" ]; then
      echo ".env file created successfully."
    else
      echo "Error: .env file is missing or empty."
      exit 1
    fi

    working-directory ${{ github.workspace }}

    expert "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
    export "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
    export "ENABLE_GOOGLE_AUTH=${{ secrets.ENABLE_GOOGLE_AUTH }}"

    export "ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}"
    export "ENCRYPTION_IV=${{ secrets.ENCRYPTION_IV }}"

    export "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}"
    export "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}"
    export "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}"

    export "DB_HOST=${{ secrets.DB_HOST }}"
    export "DB_NAME=${{ secrets.DB_NAME }}"
    export "DB_USER=${{ secrets.DB_USER }}"
    export "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
    export "DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5432/${{ secrets.DB_NAME }}"
    # Verify exports (without revealing sensitive information)
    echo "Environment variables exported:"
    env | grep -E "GOOGLE_CLIENT_ID|ENABLE_GOOGLE_AUTH|NEXTAUTH_URL|NEXT_PUBLIC_API_URL|DB_HOST|DB_NAME|DB_USER" | sed 's/=.*/=<redacted>/'
  shell: bash
